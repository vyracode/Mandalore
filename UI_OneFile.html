<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mandalore</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;600&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --pink: #FF4FD8;
            --green: #2AF59A;
            --purple: #7A5CFF;
            --orange: #FFB020;
            --cyan: #28D8FF;

            /* Radial brand blend (same palette) */
            --brand-gradient:
                radial-gradient(140% 140% at 0% 35%, rgba(255, 79, 216, .95) 0%, rgba(255, 79, 216, 0) 58%),
                radial-gradient(140% 140% at 28% 0%, rgba(122, 92, 255, .95) 0%, rgba(122, 92, 255, 0) 60%),
                radial-gradient(140% 140% at 72% 0%, rgba(40, 216, 255, .95) 0%, rgba(40, 216, 255, 0) 62%),
                radial-gradient(140% 140% at 100% 45%, rgba(42, 245, 154, .90) 0%, rgba(42, 245, 154, 0) 60%),
                radial-gradient(160% 160% at 55% 115%, rgba(255, 176, 32, .92) 0%, rgba(255, 176, 32, 0) 62%),
                radial-gradient(140% 140% at 50% 55%, var(--purple) 0%, var(--purple) 100%);

            --bg0: #090A0E;
            --bg1: #0E1020;
            --text: rgba(255, 255, 255, .92);
            --muted: rgba(255, 255, 255, .60);

            --shadow: 0 10px 30px rgba(0, 0, 0, .45);
            --radius: 18px;
            --radius2: 26px;
            --tap: 44px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--text);
            background:
                radial-gradient(1000px 800px at 20% -10%, rgba(122, 92, 255, .25), transparent 55%),
                radial-gradient(900px 700px at 100% 0%, rgba(255, 79, 216, .18), transparent 50%),
                radial-gradient(900px 700px at 10% 110%, rgba(40, 216, 255, .16), transparent 55%),
                radial-gradient(850px 650px at 100% 120%, rgba(42, 245, 154, .12), transparent 55%),
                linear-gradient(180deg, var(--bg0), var(--bg1));
            overflow: hidden;
        }

        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        main {
            flex: 1 1 auto;
            min-height: 0;
            /* match nav's horizontal padding */
            padding: 13px 12px 0;
            display: flex;
        }

        .screen-inner {
            flex: 1;
            min-height: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Bottom bar */
        nav {
            height: 92px;
            padding: 13px 12px 17px;
        }

        .tabbar {
            height: 100%;
            border-radius: 22px;
            background: rgba(15, 17, 38, .72);
            border: 1px solid rgba(255, 255, 255, .10);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 18px 44px rgba(0, 0, 0, .45), inset 0 1px 0 rgba(255, 255, 255, .06);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 11px;
            padding: 11px;
        }

        .tab {
            appearance: none;
            border: 0;
            background: transparent;
            color: var(--muted);
            height: 100%;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 800;
            font-size: 13px;
            cursor: pointer;
            user-select: none;
        }

        .tab .ico {
            width: 22px;
            height: 22px;
            display: grid;
            place-items: center;
            border-radius: 10px;
            background: rgba(255, 255, 255, .06);
            border: 1px solid rgba(255, 255, 255, .10);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06);
        }

        .tab[data-active="true"] {
            color: var(--text);
            background: linear-gradient(135deg, rgba(122, 92, 255, .22), rgba(255, 79, 216, .15));
            border: 1px solid rgba(255, 255, 255, .12);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .28), inset 0 1px 0 rgba(255, 255, 255, .10);
        }

        .tab[data-active="true"] .ico {
            background: linear-gradient(135deg, rgba(255, 176, 32, .22), rgba(40, 216, 255, .16));
            border-color: rgba(255, 255, 255, .14);
        }

        /* Shared controls */
        .btn {
            height: var(--tap);
            border-radius: 14px;
            padding: 0 14px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .06);
            color: var(--text);
            font-weight: 900;
            font-size: 13px;
            letter-spacing: .2px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .08);
            user-select: none;
        }

        .btn:active {
            transform: translateY(1px)
        }

        .btn.primary {
            background: linear-gradient(135deg, rgba(255, 79, 216, .22), rgba(122, 92, 255, .22));
            border-color: rgba(255, 255, 255, .14);
        }

        .btn.good {
            background: linear-gradient(135deg, rgba(42, 245, 154, .20), rgba(40, 216, 255, .12));
        }

        .btn.bad {
            background: linear-gradient(135deg, rgba(255, 176, 32, .22), rgba(255, 79, 216, .10));
        }

        .btn.ghost {
            background: transparent;
            border-color: rgba(255, 255, 255, .10);
            color: var(--muted);
        }

        /* Floating Next (Flashcards) */
        .fab-next {
            position: fixed;
            right: 12px;
            bottom: calc(92px + 14px + env(safe-area-inset-bottom));
            height: 54px;
            padding: 0 18px;
            border-radius: 18px;
            z-index: 30;
            box-shadow: 0 22px 60px rgba(0, 0, 0, .45), inset 0 1px 0 rgba(255, 255, 255, .10);
        }

        .seg {
            display: flex;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, .10);
            overflow: hidden;
            background: rgba(255, 255, 255, .04);
            height: 44px;
        }

        .seg button {
            flex: 1;
            border: 0;
            background: transparent;
            color: var(--muted);
            font-weight: 900;
            cursor: pointer;
        }

        .seg button[data-on="true"] {
            color: var(--text);
            background: linear-gradient(135deg, rgba(40, 216, 255, .16), rgba(122, 92, 255, .16));
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .08);
        }

        .field {
            width: 100%;
            height: var(--tap);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .04);
            color: var(--text);
            padding: 0 12px;
            font-size: 14px;
            font-weight: 650;
            outline: none;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06);
        }

        .field::placeholder {
            color: rgba(255, 255, 255, .35);
            font-weight: 600
        }

        .mono {
            font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .panel {
            border-radius: var(--radius);
            background: rgba(18, 20, 43, .62);
            border: 1px solid rgba(255, 255, 255, .10);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06);
            overflow: hidden;
        }

        .panel .ph {
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .panel .ph h2 {
            margin: 0;
            font-size: 13px;
            color: var(--muted);
            font-weight: 900;
            letter-spacing: .18px;
        }

        /* Flashcards */
        .flash-layout {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            min-height: 0;
        }

        .card-stack {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .front-card {
            flex: 0 0 180px;
            min-height: 180px;
            border-radius: 22px;
            background:
                radial-gradient(600px 250px at 20% 0%, rgba(255, 79, 216, .22), transparent 55%),
                radial-gradient(500px 240px at 95% 10%, rgba(40, 216, 255, .20), transparent 58%),
                linear-gradient(135deg, rgba(122, 92, 255, .22), rgba(255, 255, 255, .03));
            border: 1px solid rgba(255, 255, 255, .12);
            box-shadow: 0 18px 46px rgba(0, 0, 0, .45), inset 0 1px 0 rgba(255, 255, 255, .10);
            overflow: hidden;
            padding: 14px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 12px;
        }

        .front-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .badge {
            height: 28px;
            border-radius: 999px;
            padding: 0 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, .20);
            border: 1px solid rgba(255, 255, 255, .14);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .08);
            font-weight: 900;
            font-size: 12px;
            color: rgba(255, 255, 255, .86);
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 99px;
            background: var(--cyan);
            box-shadow: 0 0 0 3px rgba(40, 216, 255, .18)
        }

        .front-body {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex: 1;
            min-height: 0;
            padding: 6px 8px;
        }

        .front-hanzi {
            font-size: 56px;
            font-weight: 950;
            letter-spacing: 2px;
            line-height: 1.05;
            text-shadow: 0 10px 34px rgba(0, 0, 0, .35);
        }

        .front-meaning {
            font-size: 26px;
            font-weight: 950;
            line-height: 1.15;
        }

        .front-pinyin {
            font-size: 30px;
            font-weight: 950;
            letter-spacing: .2px;
        }

        .front-audio {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 10px;
        }

        .sound {
            width: 64px;
            height: 64px;
            border-radius: 22px;
            border: 1px solid rgba(255, 255, 255, .14);
            background: rgba(0, 0, 0, .20);
            box-shadow: 0 14px 34px rgba(0, 0, 0, .30), inset 0 1px 0 rgba(255, 255, 255, .10);
            display: grid;
            place-items: center;
            cursor: pointer;
        }

        .waves {
            display: flex;
            gap: 6px;
            align-items: flex-end;
            height: 38px;
        }

        .waves span {
            width: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .78);
            opacity: .9;
            transform-origin: bottom;
            animation: wave 1.05s ease-in-out infinite;
        }

        .waves span:nth-child(2) {
            animation-delay: .09s;
            opacity: .82
        }

        .waves span:nth-child(3) {
            animation-delay: .18s;
            opacity: .76
        }

        .waves span:nth-child(4) {
            animation-delay: .27s;
            opacity: .70
        }

        @keyframes wave {

            0%,
            100% {
                height: 10px
            }

            50% {
                height: 34px
            }
        }

        .front-foot {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            color: rgba(255, 255, 255, .70);
            font-weight: 850;
            font-size: 12px;
        }

        .spark {
            width: 10px;
            height: 10px;
            border-radius: 4px;
            background: var(--pink);
            box-shadow: 0 0 0 3px rgba(255, 79, 216, .16)
        }

        /* Modalities */
        .mod {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mod-card {
            border-radius: 18px;
            background: rgba(18, 20, 43, .60);
            border: 1px solid rgba(255, 255, 255, .10);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06);
            overflow: hidden;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mod-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .chip {
            height: 26px;
            padding: 0 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(0, 0, 0, .18);
            font-weight: 900;
            font-size: 12px;
            color: rgba(255, 255, 255, .78);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .chip .mini {
            width: 7px;
            height: 7px;
            border-radius: 99px;
            background: var(--orange);
            box-shadow: 0 0 0 3px rgba(255, 176, 32, .14)
        }

        .mod-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .mod-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .answer {
            display: none;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(0, 0, 0, .18);
            padding: 10px 12px;
            color: rgba(255, 255, 255, .86);
            font-weight: 850;
            font-size: 14px;
            line-height: 1.25;
        }

        .answer strong {
            font-weight: 950
        }

        .result {
            display: none;
            align-items: center;
            gap: 10px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(0, 0, 0, .18);
            padding: 10px 12px;
            font-weight: 950;
            font-size: 13px;
        }

        .result .r-dot {
            width: 10px;
            height: 10px;
            border-radius: 99px
        }

        .result.good .r-dot {
            background: var(--green);
            box-shadow: 0 0 0 3px rgba(42, 245, 154, .16)
        }

        .result.bad .r-dot {
            background: var(--pink);
            box-shadow: 0 0 0 3px rgba(255, 79, 216, .16)
        }

        .selfgrade {
            display: none;
        }

        /* Audio reveal (reuse front audio UI inside cards) */
        .audio-reveal {
            display: none;
        }

        .audio-reveal .front-audio {
            padding: 6px 2px;
        }

        /* Pronunciation split */
        .mod-body.pron {
            gap: 12px
        }

        .pron-block {
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(0, 0, 0, .16);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .pron-block.pron-tone {
            background:
                radial-gradient(520px 160px at 20% 0%, rgba(122, 92, 255, .18), transparent 60%),
                rgba(0, 0, 0, .14);
        }

        .pron-block.pron-speak {
            background:
                radial-gradient(520px 160px at 90% 0%, rgba(42, 245, 154, .14), transparent 60%),
                rgba(0, 0, 0, .14);
        }

        .pron-divider {
            height: 2px;
            border-radius: 99px;
            background: linear-gradient(90deg, rgba(255, 79, 216, .0), rgba(255, 79, 216, .35), rgba(40, 216, 255, .35), rgba(42, 245, 154, .25), rgba(255, 176, 32, .0));
            opacity: .9;
        }

        .pron-self .btn {
            flex: 1
        }

        /* Hanzi choices */
        .choices {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .choice {
            height: 44px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
            color: rgba(255, 255, 255, .86);
            font-weight: 950;
            font-size: 18px;
            cursor: pointer;
            display: grid;
            place-items: center;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06);
            user-select: none;
            transition: box-shadow .16s ease-out, transform .16s ease-out, background .16s ease-out;
        }

        .choice[data-picked="true"] {
            outline: none;
            /* soft, smaller glow */
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, .10),
                0 0 9px 1px rgba(40, 216, 255, .18),
                0 0 18px 4px rgba(40, 216, 255, .10),
                0 12px 28px rgba(0, 0, 0, .30);
        }

        .choice[data-grade="correct"] {
            background: linear-gradient(135deg, rgba(42, 245, 154, .20), rgba(40, 216, 255, .12));
            border-color: rgba(255, 255, 255, .14);
        }

        .choice[data-grade="wrong"] {
            background: linear-gradient(135deg, rgba(255, 176, 32, .22), rgba(255, 79, 216, .10));
            border-color: rgba(255, 255, 255, .14);
        }

        /* Translation */
        .translate-layout {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .translate-card {
            flex: 1;
            min-height: 0;
            border-radius: 22px;
            background: rgba(18, 20, 43, .62);
            border: 1px solid rgba(255, 255, 255, .10);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .prompt {
            border-radius: 18px;
            background: rgba(0, 0, 0, .20);
            border: 1px solid rgba(255, 255, 255, .10);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .prompt .label {
            font-size: 12px;
            font-weight: 950;
            color: rgba(255, 255, 255, .72);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prompt .label .k {
            width: 9px;
            height: 9px;
            border-radius: 4px;
            background: var(--purple);
            box-shadow: 0 0 0 3px rgba(122, 92, 255, .14)
        }

        .prompt .txt {
            font-size: 18px;
            font-weight: 900;
            line-height: 1.2;
            letter-spacing: .15px;
        }

        .input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        textarea {
            flex: 1;
            min-height: 0;
            width: 100%;
            resize: none;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .04);
            color: var(--text);
            padding: 12px;
            font-size: 15px;
            font-weight: 650;
            line-height: 1.25;
            outline: none;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06);
        }

        .translate-actions {
            display: flex;
            gap: 10px;
        }

        .translate-actions .btn {
            flex: 1
        }

        .feedback {
            display: none;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
        }

        .sentence {
            border-radius: 18px;
            background: rgba(0, 0, 0, .20);
            border: 1px solid rgba(255, 255, 255, .10);
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-content: flex-start;
            min-height: 0;
        }

        .sentence.sentence-correct {
            background: transparent;
            border: 0;
            padding: 0;
        }

        .w {
            border-radius: 999px;
            padding: 8px 10px;
            border: 1px solid rgba(255, 255, 255, .10);
            color: rgba(255, 255, 255, .92);
            font-weight: 950;
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
            transition: transform .12s ease-out;
        }

        .w[data-selected="true"] {
            outline: 2px solid rgba(255, 255, 255, .22);
            box-shadow: 0 0 0 4px rgba(40, 216, 255, .14);
            transform: translateY(-1px);
        }

        .w.ok {
            background: rgba(42, 245, 154, .10)
        }

        .w.spelling {
            background: rgba(255, 176, 32, .10)
        }

        .w.wrong {
            background: rgba(255, 79, 216, .10)
        }

        .w.missing {
            background: rgba(122, 92, 255, .10)
        }

        .w.extra {
            background: rgba(40, 216, 255, .10)
        }

        .detail {
            border-radius: 18px;
            background: rgba(0, 0, 0, .20);
            border: 1px solid rgba(255, 255, 255, .10);
            padding: 12px;
            min-height: 96px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detail .tag {
            font-size: 12px;
            font-weight: 950;
            color: rgba(255, 255, 255, .70);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail .tag .k {
            width: 9px;
            height: 9px;
            border-radius: 4px;
            background: rgba(255, 255, 255, .22);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, .10)
        }

        .detail .dbody {
            font-weight: 850;
            color: rgba(255, 255, 255, .86);
            line-height: 1.25;
        }

        /* Settings */
        .settings-layout {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .grid2 {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            min-height: 0;
        }

        .setting-card {
            border-radius: 22px;
            background: rgba(18, 20, 43, .62);
            border: 1px solid rgba(255, 255, 255, .10);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .setting-row .label {
            font-weight: 950;
            font-size: 13px;
            color: rgba(255, 255, 255, .82);
        }

        .setting-row .hint {
            margin-top: 4px;
            font-size: 12px;
            color: var(--muted);
            font-weight: 650;
        }

        .pill {
            height: 38px;
            border-radius: 999px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, .06);
            border: 1px solid rgba(255, 255, 255, .10);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .08);
            color: var(--text);
            font-weight: 800;
            font-size: 13px;
            user-select: none;
            flex: 0 0 auto;
        }

        .pill small {
            color: var(--muted);
            font-weight: 800
        }

        .textarea-small {
            height: 150px;
            flex: 0 0 auto;
        }

        .error {
            display: none;
            border-radius: 16px;
            border: 1px solid rgba(255, 79, 216, .20);
            background: rgba(255, 79, 216, .08);
            padding: 10px 12px;
            color: rgba(255, 255, 255, .90);
            font-weight: 850;
            line-height: 1.25;
        }

        .ok {
            display: none;
            border-radius: 16px;
            border: 1px solid rgba(42, 245, 154, .20);
            background: rgba(42, 245, 154, .08);
            padding: 10px 12px;
            color: rgba(255, 255, 255, .90);
            font-weight: 850;
            line-height: 1.25;
        }

        /* Settings wordmark area (no box) */
        .settings-brand {
            flex: 1;
            min-height: 0;
            display: grid;
            place-items: center;
            padding: 6px 0;
        }

        .wordmark {
            font-weight: 950;
            letter-spacing: .6px;
            font-size: 36px;
            line-height: 1;
            text-align: center;
            background: var(--brand-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 18px 50px rgba(0, 0, 0, .40);
        }

        .hide {
            display: none !important
        }

        button:focus-visible,
        input:focus-visible,
        textarea:focus-visible {
            outline: 2px solid rgba(40, 216, 255, .45);
            outline-offset: 2px;
        }

        @media (min-width: 840px) {
            main {
                padding: 13px 18px 0
            }

            nav {
                padding: 13px 18px 17px
            }

            .front-card {
                flex-basis: 210px;
                min-height: 210px
            }

            .fab-next {
                right: 18px
            }
        }
    </style>
</head>

<body>
    <div class="app" id="app">

        <main>
            <div class="screen-inner">

                <!-- FLASHCARDS -->
                <div id="screen-flash" class="flash-layout">
                    <div class="card-stack">
                        <div class="front-card" id="frontCard">
                            <div class="front-top">
                                <div class="badge" id="frontBadge"><span class="dot" aria-hidden="true"></span><span
                                        id="frontLabel">Hanzi</span></div>
                            </div>

                            <div class="front-body" id="frontBody">
                                <div class="front-hanzi" id="frontText">Ê¨¢Ëøé</div>
                            </div>

                            <div class="front-foot">
                                <span class="spark" aria-hidden="true"></span><span id="frontHint">Recognize the
                                    word</span>
                            </div>
                        </div>

                        <div class="mod" id="modStack">

                            <!-- Pronunciation -->
                            <div class="mod-card" data-mod="pronunciation" id="modPron">
                                <div class="mod-head">
                                    <div class="chip"><span class="mini" aria-hidden="true"></span> Pronunciation</div>
                                    <div class="mod-actions"></div>
                                </div>

                                <div class="mod-body pron">
                                    <div class="pron-block pron-tone">
                                        <div class="row" style="justify-content:space-between">
                                            <input class="field mono" inputmode="numeric" pattern="[0-9]*"
                                                placeholder="tone numbers" data-input="tone"
                                                aria-label="Tone numbers" />
                                            <button class="btn" data-action="checkTone" type="button">Check</button>
                                        </div>

                                        <div class="result" data-role="toneResult"><span class="r-dot"
                                                aria-hidden="true"></span><span data-role="toneMsg">Right</span></div>
                                        <div class="answer" data-role="toneAnswer"></div>
                                    </div>

                                    <div class="pron-divider" aria-hidden="true"></div>

                                    <div class="pron-block pron-speak">
                                        <div class="row" style="justify-content:space-between">
                                            <div class="chip" style="background: rgba(0,0,0,.12)"><span class="mini"
                                                    style="background: var(--cyan); box-shadow: 0 0 0 3px rgba(40,216,255,.14)"
                                                    aria-hidden="true"></span> Say it out loud</div>
                                            <button class="btn" data-action="checkSpeech" type="button">Check</button>
                                        </div>

                                        <div class="audio-reveal" data-role="speechAnswer"></div>
                                        <div class="result" data-role="speechResult"><span class="r-dot"
                                                aria-hidden="true"></span><span data-role="speechMsg">Right</span></div>

                                        <div class="row selfgrade pron-self" data-role="speechSelf">
                                            <button class="btn good" data-action="selfRight"
                                                type="button">Right</button>
                                            <button class="btn bad" data-action="selfWrong" type="button">Wrong</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pinyin spelling (graded) -->
                            <div class="mod-card" data-mod="pinyin" id="modPinyin">
                                <div class="mod-head">
                                    <div class="chip"><span class="mini"
                                            style="background: var(--purple); box-shadow: 0 0 0 3px rgba(122,92,255,.14)"
                                            aria-hidden="true"></span> Spelling</div>
                                    <div class="mod-actions"></div>
                                </div>
                                <div class="mod-body">
                                    <div class="row">
                                        <input class="field mono" placeholder="pinyin (no tones)" data-input="pinyin"
                                            aria-label="Pinyin spelling" />
                                        <button class="btn" data-action="checkPinyin" type="button">Check</button>
                                    </div>
                                    <div class="result" data-role="pinyinResult"><span class="r-dot"
                                            aria-hidden="true"></span><span data-role="pinyinMsg">Right</span></div>
                                    <div class="answer" data-role="pinyinAnswer"></div>
                                </div>
                            </div>

                            <!-- Hanzi (multiple choice) -->
                            <div class="mod-card" data-mod="hanzi" id="modHanzi">
                                <div class="mod-head">
                                    <div class="chip"><span class="mini"
                                            style="background: var(--cyan); box-shadow: 0 0 0 3px rgba(40,216,255,.14)"
                                            aria-hidden="true"></span> Hanzi</div>
                                    <div class="mod-actions"></div>
                                </div>
                                <div class="mod-body">
                                    <div class="choices" role="group" aria-label="Hanzi choices">
                                        <button class="choice" data-choice type="button">Ê¨¢Ëøé</button>
                                        <button class="choice" data-choice type="button">ÁéØÂ¢É</button>
                                        <button class="choice" data-choice type="button">ÁºìÂ∫î</button>
                                        <button class="choice" data-choice type="button">Ê¨¢È•Æ</button>
                                        <button class="choice" data-choice type="button">Ê¨¢ËøéÂêß</button>
                                        <button class="choice" data-choice type="button">Ê¨¢ÂΩ±</button>
                                    </div>
                                    <div class="result" data-role="hanziResult"><span class="r-dot"
                                            aria-hidden="true"></span><span data-role="hanziMsg">Right</span></div>
                                    <div class="answer" data-role="hanziAnswer"></div>
                                </div>
                            </div>

                            <!-- Meaning (self-grade after check) -->
                            <div class="mod-card" data-mod="meaning" id="modMeaning">
                                <div class="mod-head">
                                    <div class="chip"><span class="mini"
                                            style="background: var(--orange); box-shadow: 0 0 0 3px rgba(255,176,32,.14)"
                                            aria-hidden="true"></span> Meaning</div>
                                    <div class="mod-actions">
                                        <button class="btn" data-action="checkMeaning" type="button">Check</button>
                                    </div>
                                </div>
                                <div class="mod-body">
                                    <div class="answer" data-role="meaningAnswer"></div>
                                    <div class="result" data-role="meaningResult"><span class="r-dot"
                                            aria-hidden="true"></span><span data-role="meaningMsg">Right</span></div>
                                    <div class="row selfgrade" data-role="meaningSelf">
                                        <button class="btn good" data-action="selfRight" type="button"
                                            style="flex:1">Right</button>
                                        <button class="btn bad" data-action="selfWrong" type="button"
                                            style="flex:1">Wrong</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- TRANSLATION -->
                <div id="screen-translate" class="translate-layout hide">
                    <div class="panel">
                        <div class="ph">
                            <h2>Translation</h2>
                            <div class="seg" role="tablist" aria-label="Translation direction">
                                <button id="dirENZH" data-on="true" role="tab" aria-selected="true" type="button">EN ‚Üí
                                    ‰∏≠Êñá</button>
                                <button id="dirZHEN" data-on="false" role="tab" aria-selected="false" type="button">‰∏≠Êñá ‚Üí
                                    EN</button>
                            </div>
                        </div>
                    </div>

                    <div class="translate-card">
                        <!-- A -->
                        <div id="translateA" style="display:flex; flex-direction:column; gap:12px; min-height:0;">
                            <div class="prompt">
                                <div class="label"><span class="k" aria-hidden="true"></span><span
                                        id="translateLabel">Translate into ‰∏≠Êñá</span></div>
                                <div class="txt" id="promptText">Welcome home. Do you want bread?</div>
                            </div>

                            <div class="input-area">
                                <textarea id="userTranslation" placeholder="Type Hanzi, Pinyin, and/or English"
                                    aria-label="Your translation"></textarea>
                                <div class="translate-actions">
                                    <button class="btn ghost" id="btnNewSentence" type="button">New sentence</button>
                                    <button class="btn primary" id="btnSubmitTranslation" type="button">Check</button>
                                </div>
                            </div>
                        </div>

                        <!-- B -->
                        <div id="translateB" class="feedback">
                            <div class="prompt" style="gap:6px">
                                <div class="label" style="justify-content:space-between; width:100%">
                                    <span style="display:flex; align-items:center; gap:8px">
                                        <span class="k"
                                            style="background: var(--purple); box-shadow: 0 0 0 3px rgba(122,92,255,.14)"
                                            aria-hidden="true"></span>
                                        <span>Summary</span>
                                    </span>
                                    <button class="btn ghost" id="btnBackToInput" type="button">Back</button>
                                </div>
                                <div class="txt" id="fbOverview"
                                    style="font-size:14px; font-weight:850; color: rgba(255,255,255,.86)">Nice
                                    structure. Two word choices are off, and one word is missing.</div>
                            </div>

                            <div class="prompt" style="gap:10px">
                                <div class="sentence sentence-correct" id="fbSentence" aria-label="Per-word feedback">
                                </div>
                            </div>

                            <div class="detail" id="fbDetail" aria-live="polite" style="display:none">
                                <div class="tag"><span class="k" aria-hidden="true"></span><span id="detailTag"></span>
                                </div>
                                <div class="dbody" id="detailBody"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SETTINGS -->
                <div id="screen-settings" class="settings-layout hide">
                    <div class="panel">
                        <div class="ph">
                            <h2>Settings</h2>
                            <button class="btn ghost" id="btnReset" type="button">Reset UI</button>
                        </div>
                    </div>

                    <div class="grid2">
                        <div class="setting-card">
                            <div class="setting-row">
                                <div>
                                    <div class="label">Gemini API key</div>
                                    <div class="hint">Used for Translation Practice</div>
                                </div>
                                <div class="pill" title="Key status"><span
                                        aria-hidden="true">üîë</span><small>Status</small><span id="keyStatus">Not
                                        set</span></div>
                            </div>
                            <input id="apiKey" class="field mono" placeholder="AIza‚Ä¶" aria-label="Gemini API key" />
                            <div style="display:flex; gap:10px">
                                <button class="btn primary" id="btnSaveKey" style="flex:1" type="button">Save</button>
                                <button class="btn ghost" id="btnClearKey" style="flex:1" type="button">Clear</button>
                            </div>
                        </div>

                        <div class="setting-card">
                            <div class="setting-row" style="align-items:flex-start">
                                <div>
                                    <div class="label">Import wordlist</div>
                                    <div class="hint">Paste JSON array of {word,pinyin,definition}</div>
                                </div>
                            </div>

                            <textarea id="wordlistJson" class="textarea-small mono" aria-label="Wordlist JSON">[
  {"word":"Ê¨¢Ëøé","pinyin":"huƒÅny√≠ng","definition":"welcome"},
  {"word":"Èù¢ÂåÖ","pinyin":"mi√†nbƒÅo","definition":"bread"}
]</textarea>

                            <div class="error" id="importError"></div>
                            <div class="ok" id="importOk"></div>

                            <div style="display:flex; gap:10px">
                                <button class="btn primary" id="btnImport" style="flex:1" type="button">Import</button>
                                <button class="btn ghost" id="btnClearList" style="flex:1" type="button">Clear</button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-brand" aria-label="Mandalore">
                        <div class="wordmark">Mandalore</div>
                    </div>
                </div>

            </div>
        </main>

        <nav>
            <div class="tabbar" role="tablist" aria-label="Playgrounds">
                <button class="tab" id="tabFlash" data-active="true" role="tab" aria-selected="true" type="button">
                    <span class="ico" aria-hidden="true">üÉè</span>
                    <span>Flashcards</span>
                </button>
                <button class="tab" id="tabTranslate" data-active="false" role="tab" aria-selected="false"
                    type="button">
                    <span class="ico" aria-hidden="true">üåê</span>
                    <span>Translation</span>
                </button>
                <button class="tab" id="tabSettings" data-active="false" role="tab" aria-selected="false" type="button">
                    <span class="ico" aria-hidden="true">‚öôÔ∏è</span>
                    <span>Settings</span>
                </button>
            </div>
        </nav>

        <button class="btn primary fab-next" id="btnFabNext" type="button" aria-label="Next card">
            Next <span aria-hidden="true">‚Üí</span>
        </button>

    </div>

    <script>
        // UI only (vanilla). Guarded bindings + DOMContentLoaded.

        const state = {
            tab: 'flash',
            sessionCount: 12,
            translationDir: 'ENZH',
            card: {
                front: 'hanzi',
                word: 'Ê¨¢Ëøé',
                pinyinToned: 'huƒÅny√≠ng',
                pinyinBare: 'huanying',
                tones: '12',
                meaning: 'welcome',
                audioLabel: 'Pronunciation',
            },
            translation: {
                promptEN: 'Welcome home. Do you want bread?',
                promptZH: 'Ê¨¢ËøéÂõûÂÆ∂„ÄÇ‰Ω†ÊÉ≥Ë¶ÅÈù¢ÂåÖÂêóÔºü',
                feedbackOverview: 'Nice structure. Two word choices are off, and one word is missing.',
                tokens: [
                    { text: 'Ê¨¢Ëøé', cls: 'ok', detail: 'Correct.' },
                    { text: 'ÂõûÂÆ∂', cls: 'ok', detail: 'Correct.' },
                    { text: '‰Ω†', cls: 'missing', detail: 'Missing word. Add ‰Ω† before ÊÉ≥Ë¶Å.' },
                    { text: 'ÊÉ≥Ë¶Å', cls: 'spelling', detail: 'Form is slightly off. Preferred: ÊÉ≥Ë¶Å.' },
                    { text: 'Èù¢ÂåÖ', cls: 'wrong', detail: 'Wrong word choice. Use Èù¢ÂåÖ (mi√†nbƒÅo) for bread.' },
                    { text: 'Âêó', cls: 'extra', detail: 'Extra word. Your sentence already forms a question.' },
                ],
            },
            imported: { deckName: 'My Wordlist' }
        };

        const $ = (q, el = document) => el.querySelector(q);
        const $$ = (q, el = document) => [...el.querySelectorAll(q)];

        function on(sel, type, handler, opts) {
            const el = $(sel);
            if (!el) return false;
            el.addEventListener(type, handler, opts);
            return true;
        }

        function runSmokeTests() {
            // Tests (logged only; never throws)
            const required = [
                '#tabFlash', '#tabTranslate', '#tabSettings',
                '#screen-flash', '#screen-translate', '#screen-settings',
                '#btnFabNext',
                '#modPron', '#modPinyin', '#modHanzi', '#modMeaning',
                '#fbSentence', '#btnSubmitTranslation', '#btnNewSentence', '#btnBackToInput',
                '#btnImport', '#btnReset'
            ];
            const missing = required.filter(s => !$(s));
            if (missing.length) {
                console.warn('[Mandalore UI] Missing required elements:', missing);
            } else {
                console.debug('[Mandalore UI] Smoke tests passed');
            }
        }

        function setTab(tab) {
            state.tab = tab;
            const map = {
                flash: { tab: $('#tabFlash'), screen: $('#screen-flash') },
                translate: { tab: $('#tabTranslate'), screen: $('#screen-translate') },
                settings: { tab: $('#tabSettings'), screen: $('#screen-settings') },
            };
            Object.entries(map).forEach(([k, v]) => {
                if (!v.tab || !v.screen) return;
                const on = (k === tab);
                v.tab.dataset.active = String(on);
                v.tab.setAttribute('aria-selected', on ? 'true' : 'false');
                v.screen.classList.toggle('hide', !on);
            });

            const fab = $('#btnFabNext');
            if (fab) fab.classList.toggle('hide', tab !== 'flash');
        }

        function bumpSession(n) {
            state.sessionCount = Math.max(0, state.sessionCount + n);
        }

        // --- Flashcards ---
        const FRONT_ORDER = ['hanzi', 'pronunciation', 'pinyin', 'meaning'];
        const FRONT_LABEL = { hanzi: 'Hanzi', pronunciation: 'Audio', pinyin: 'Pinyin', meaning: 'Meaning' };
        const FRONT_HINT = { hanzi: 'Recognize the word', pronunciation: 'Recognize the sound', pinyin: 'Recognize the spelling', meaning: 'Recall the Mandarin' };

        function renderFront() {
            const f = state.card.front;
            const fl = $('#frontLabel');
            const fh = $('#frontHint');
            const body = $('#frontBody');
            if (!fl || !fh || !body) return;

            fl.textContent = FRONT_LABEL[f];
            fh.textContent = FRONT_HINT[f];
            body.innerHTML = '';

            if (f === 'hanzi') {
                const d = document.createElement('div');
                d.className = 'front-hanzi';
                d.textContent = state.card.word;
                body.appendChild(d);
            } else if (f === 'meaning') {
                const d = document.createElement('div');
                d.className = 'front-meaning';
                d.textContent = state.card.meaning;
                body.appendChild(d);
            } else if (f === 'pinyin') {
                const d = document.createElement('div');
                d.className = 'front-pinyin mono';
                d.textContent = state.card.pinyinToned;
                body.appendChild(d);
            } else {
                const wrap = document.createElement('div');
                wrap.className = 'front-audio';

                const btn = document.createElement('button');
                btn.className = 'sound';
                btn.type = 'button';
                btn.setAttribute('aria-label', 'Play pronunciation');
                btn.innerHTML = '<div class="waves" aria-hidden="true"><span></span><span></span><span></span><span></span></div>';
                btn.addEventListener('click', () => {
                    btn.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.03)' }, { transform: 'scale(1)' }], { duration: 220, easing: 'ease-out' });
                });
                wrap.appendChild(btn);

                const d = document.createElement('div');
                d.style.textAlign = 'left';
                d.innerHTML = `<div style="font-weight:950; font-size:16px; letter-spacing:.2px">${state.card.audioLabel}</div><div style="margin-top:4px; color: rgba(255,255,255,.65); font-weight:800; font-size:12px">Tap to play</div>`;
                wrap.appendChild(d);

                body.appendChild(wrap);
            }

            const dot = $('#frontBadge .dot');
            if (dot) {
                const c = { hanzi: 'var(--cyan)', pronunciation: 'var(--green)', pinyin: 'var(--purple)', meaning: 'var(--orange)' }[f];
                dot.style.background = c;
            }
        }

        function resetModality(modCard) {
            if (!modCard) return;
            $$('[data-choice]', modCard).forEach(b => b.dataset.picked = 'false');
            $$('input', modCard).forEach(i => { i.value = ''; });
            $$('[data-role$="Result"]', modCard).forEach(r => { r.style.display = 'none'; r.classList.remove('good', 'bad'); });
            $$('[data-role$="Answer"]', modCard).forEach(a => { a.style.display = 'none'; a.innerHTML = ''; });
            $$('[data-role$="Self"]', modCard).forEach(s => { s.style.display = 'none'; });
            $$('.selfgrade', modCard).forEach(s => { s.style.display = 'none'; });

            // clear hanzi grades
            $$('[data-choice]', modCard).forEach(b => { delete b.dataset.grade; });
        }

        function resetAllBack() {
            ['#modPron', '#modPinyin', '#modHanzi', '#modMeaning'].forEach(sel => resetModality($(sel)));
        }

        function cycleFront() {
            const i = FRONT_ORDER.indexOf(state.card.front);
            state.card.front = FRONT_ORDER[(i + 1) % FRONT_ORDER.length];
            renderFront();
        }

        function showResult(modCard, ok, msg, role) {
            const result = modCard ? $(`[data-role="${role}Result"]`, modCard) : null;
            const textEl = modCard ? $(`[data-role="${role}Msg"]`, modCard) : null;
            if (!result) return;
            result.style.display = 'flex';
            result.classList.toggle('good', !!ok);
            result.classList.toggle('bad', !ok);
            if (textEl) textEl.textContent = msg;
        }

        function wireSoundButtons(scope = document) {
            scope.querySelectorAll('.sound').forEach((btn) => {
                if (!(btn instanceof HTMLElement)) return;
                if (btn.dataset.bound === 'true') return;
                btn.dataset.bound = 'true';
                btn.addEventListener('click', () => {
                    btn.animate(
                        [{ transform: 'scale(1)' }, { transform: 'scale(1.03)' }, { transform: 'scale(1)' }],
                        { duration: 220, easing: 'ease-out' }
                    );
                });
            });
        }

        // Pronunciation: Tone
        function checkTone(modCard) {
            const inputEl = $('[data-input="tone"]', modCard);
            const ans = $('[data-role="toneAnswer"]', modCard);
            if (!inputEl || !ans) return;

            const input = inputEl.value.trim().replace(/\\s+/g, '');
            const correct = state.card.tones;
            const ok = (input === correct);
            showResult(modCard, ok, ok ? 'Right' : 'Wrong', 'tone');
            bumpSession(ok ? 1 : 0);

            ans.style.display = 'block';
            ans.innerHTML = `<strong>Tones:</strong> <span class="mono">${correct}</span>`;
        }

        // Pronunciation: Speak
        function checkSpeech(modCard) {
            const a = $('[data-role="speechAnswer"]', modCard);
            const sg = $('[data-role="speechSelf"]', modCard);
            if (a) {
                a.style.display = 'block';
                a.innerHTML = `
          <div class="front-audio">
            <button class="sound" type="button" aria-label="Play example pronunciation">
              <div class="waves" aria-hidden="true"><span></span><span></span><span></span><span></span></div>
            </button>
            <div style="text-align:left">
              <div style="font-weight:950; font-size:16px; letter-spacing:.2px">Example audio</div>
              <div style="margin-top:4px; color: rgba(255,255,255,.65); font-weight:800; font-size:12px">Tap to play</div>
            </div>
          </div>
        `;
                wireSoundButtons(a);
            }
            if (sg) sg.style.display = 'flex';
        }

        // Pinyin spelling
        function checkPinyin(modCard) {
            const inputEl = $('[data-input="pinyin"]', modCard);
            const ans = $('[data-role="pinyinAnswer"]', modCard);
            if (!inputEl || !ans) return;

            const input = inputEl.value.trim().toLowerCase();
            const correct = state.card.pinyinBare;
            const ok = (input === correct);
            showResult(modCard, ok, ok ? 'Right' : 'Wrong', 'pinyin');
            bumpSession(ok ? 1 : 0);

            ans.style.display = 'block';
            ans.innerHTML = `<strong>Answer:</strong> <span class="mono">${correct}</span>`;
        }

        // Hanzi: pick
        function pickHanzi(modCard, btn) {
            if (!modCard || !btn) return;

            const all = $$('[data-choice]', modCard);
            const correctText = state.card.word;
            const correctBtn = all.find(b => b.textContent.trim() === correctText) || null;

            all.forEach(b => {
                b.dataset.picked = 'false';
                delete b.dataset.grade;
            });

            const ok = (btn.textContent.trim() === correctText);
            btn.dataset.picked = 'true';

            if (ok) {
                btn.dataset.grade = 'correct';
            } else {
                btn.dataset.grade = 'wrong';
                if (correctBtn) correctBtn.dataset.grade = 'correct';
            }

            showResult(modCard, ok, ok ? 'Right' : 'Wrong', 'hanzi');
            bumpSession(ok ? 1 : 0);

            const ans = $('[data-role="hanziAnswer"]', modCard);
            if (ans) {
                ans.style.display = 'block';
                ans.innerHTML = `<strong>Answer:</strong> <span style="font-size:18px">${correctText}</span>`;
            }
        }

        // Meaning: check then self-grade
        function checkMeaning(modCard) {
            const ans = $('[data-role="meaningAnswer"]', modCard);
            const sg = $('[data-role="meaningSelf"]', modCard);
            if (ans) {
                ans.style.display = 'block';
                ans.innerHTML = `<strong>Answer:</strong> ${state.card.meaning}`;
            }
            if (sg) sg.style.display = 'flex';
        }

        function selfGrade(modCard, ok, role) {
            showResult(modCard, ok, ok ? 'Right' : 'Wrong', role);
            bumpSession(ok ? 1 : 0);
        }

        function bindModality(modCard) {
            if (!modCard) return;
            modCard.addEventListener('click', (e) => {
                const t = e.target;
                if (!(t instanceof HTMLElement)) return;

                if (t.matches('[data-action="checkTone"]')) return checkTone(modCard);
                if (t.matches('[data-action="checkSpeech"]')) return checkSpeech(modCard);
                if (t.matches('[data-action="checkPinyin"]')) return checkPinyin(modCard);
                if (t.matches('[data-action="checkMeaning"]')) return checkMeaning(modCard);

                if (t.matches('[data-action="selfRight"]')) {
                    const role = t.closest('[data-role="speechSelf"]') ? 'speech' : 'meaning';
                    return selfGrade(modCard, true, role);
                }
                if (t.matches('[data-action="selfWrong"]')) {
                    const role = t.closest('[data-role="speechSelf"]') ? 'speech' : 'meaning';
                    return selfGrade(modCard, false, role);
                }

                if (t.matches('[data-choice]')) return pickHanzi(modCard, t);
            });
        }

        // --- Translation ---
        function setTranslationDir(dir) {
            state.translationDir = dir;
            const onENZH = (dir === 'ENZH');
            const b1 = $('#dirENZH');
            const b2 = $('#dirZHEN');
            if (b1) { b1.dataset.on = String(onENZH); b1.setAttribute('aria-selected', onENZH ? 'true' : 'false'); }
            if (b2) { b2.dataset.on = String(!onENZH); b2.setAttribute('aria-selected', onENZH ? 'false' : 'true'); }

            const label = $('#translateLabel');
            const prompt = $('#promptText');
            if (label) label.textContent = onENZH ? 'Translate into ‰∏≠Êñá' : 'Translate into English';
            if (prompt) prompt.textContent = onENZH ? state.translation.promptEN : state.translation.promptZH;

            showTranslateA();
        }

        function renderFeedbackTokens() {
            const host = $('#fbSentence');
            if (!host) return;
            host.innerHTML = '';

            state.translation.tokens.forEach((tok, idx) => {
                const b = document.createElement('button');
                b.className = `w ${tok.cls}`;
                b.type = 'button';
                b.dataset.idx = String(idx);
                b.dataset.selected = 'false';
                b.textContent = tok.text;
                host.appendChild(b);
            });

            setDetail(null);
        }

        function setDetail(idx) {
            const detail = $('#fbDetail');
            const tag = $('#detailTag');
            const body = $('#detailBody');
            if (!detail || !tag || !body) return;

            $$('#fbSentence .w').forEach(b => b.dataset.selected = 'false');

            if (idx === null) {
                detail.style.display = 'none';
                tag.textContent = '';
                body.textContent = '';
                return;
            }

            const tok = state.translation.tokens[idx];
            const btn = $(`#fbSentence .w[data-idx="${idx}"]`);
            if (btn) btn.dataset.selected = 'true';

            detail.style.display = 'flex';
            tag.textContent = tok.text;
            body.innerHTML = tok.detail;
        }

        function showTranslateA() {
            const a = $('#translateA');
            const b = $('#translateB');
            if (a) a.style.display = 'flex';
            if (b) b.style.display = 'none';
            const input = $('#userTranslation');
            if (input) input.focus({ preventScroll: true });
        }

        function showTranslateB() {
            const a = $('#translateA');
            const b = $('#translateB');
            if (a) a.style.display = 'none';
            if (b) b.style.display = 'flex';

            const ov = $('#fbOverview');
            if (ov) ov.textContent = state.translation.feedbackOverview;
            renderFeedbackTokens();
        }

        function newSentence() {
            const alt = {
                promptEN: 'Why do you want bread?',
                promptZH: '‰Ω†‰∏∫‰ªÄ‰πàÊÉ≥Ë¶ÅÈù¢ÂåÖÔºü',
                feedbackOverview: 'Good direction. One word is still off.',
                tokens: [
                    { text: '‰Ω†', cls: 'ok', detail: 'Correct.' },
                    { text: '‰∏∫‰ªÄ‰πà', cls: 'ok', detail: 'Correct.' },
                    { text: 'ÊÉ≥Ë¶Å', cls: 'ok', detail: 'Correct.' },
                    { text: 'Èù¢ÂåÖ', cls: 'spelling', detail: 'Spelling in your pinyin was off. Correct: mi√†nbƒÅo (Èù¢ÂåÖ).' },
                ]
            };

            const base = {
                promptEN: 'Welcome home. Do you want bread?',
                promptZH: 'Ê¨¢ËøéÂõûÂÆ∂„ÄÇ‰Ω†ÊÉ≥Ë¶ÅÈù¢ÂåÖÂêóÔºü',
                feedbackOverview: 'Nice structure. Two word choices are off, and one word is missing.',
                tokens: [
                    { text: 'Ê¨¢Ëøé', cls: 'ok', detail: 'Correct.' },
                    { text: 'ÂõûÂÆ∂', cls: 'ok', detail: 'Correct.' },
                    { text: '‰Ω†', cls: 'missing', detail: 'Missing word. Add ‰Ω† before ÊÉ≥Ë¶Å.' },
                    { text: 'ÊÉ≥Ë¶Å', cls: 'spelling', detail: 'Form is slightly off. Preferred: ÊÉ≥Ë¶Å.' },
                    { text: 'Èù¢ÂåÖ', cls: 'wrong', detail: 'Wrong word choice. Use Èù¢ÂåÖ (mi√†nbƒÅo) for bread.' },
                    { text: 'Âêó', cls: 'extra', detail: 'Extra word. Your sentence already forms a question.' },
                ]
            };

            const isBase = (state.translation.promptEN === base.promptEN);
            Object.assign(state.translation, isBase ? alt : base);

            const prompt = $('#promptText');
            if (prompt) {
                prompt.textContent = (state.translationDir === 'ENZH') ? state.translation.promptEN : state.translation.promptZH;
            }
            const input = $('#userTranslation');
            if (input) input.value = '';
            showTranslateA();
        }

        // --- Settings ---
        function renderKeyStatus() {
            const v = ($('#apiKey')?.value || '').trim();
            const s = $('#keyStatus');
            if (s) s.textContent = v ? 'Set' : 'Not set';
        }

        function showImportMessage(kind, msg) {
            const err = $('#importError');
            const ok = $('#importOk');
            if (err) err.style.display = 'none';
            if (ok) ok.style.display = 'none';
            if (kind === 'error' && err) { err.textContent = msg; err.style.display = 'block'; }
            if (kind === 'ok' && ok) { ok.textContent = msg; ok.style.display = 'block'; }
        }

        function validateWordlistJson(text) {
            let data;
            try { data = JSON.parse(text); }
            catch (e) { return { ok: false, msg: "That JSON can't be parsed. Paste a JSON array: [ {\"word\":\"‚Ä¶\",\"pinyin\":\"‚Ä¶\",\"definition\":\"‚Ä¶\"} ]" }; }
            if (!Array.isArray(data)) return { ok: false, msg: 'Top level must be a JSON array.' };
            if (data.length === 0) return { ok: false, msg: 'Array is empty. Paste at least one word.' };

            for (let i = 0; i < Math.min(30, data.length); i++) {
                const it = data[i];
                if (!it || typeof it !== 'object') return { ok: false, msg: `Item ${i + 1} must be an object.` };
                for (const k of ['word', 'pinyin', 'definition']) {
                    if (!(k in it)) return { ok: false, msg: `Item ${i + 1} is missing \"${k}\".` };
                    if (typeof it[k] !== 'string') return { ok: false, msg: `Item ${i + 1} \"${k}\" must be a string.` };
                    if (it[k].trim().length === 0) return { ok: false, msg: `Item ${i + 1} \"${k}\" is empty.` };
                }
            }
            return { ok: true, data };
        }

        function applyImportedDeck(data) {
            const first = data[0];
            state.card.word = first.word.trim();
            state.card.pinyinToned = first.pinyin.trim();
            state.card.meaning = first.definition.trim();

            state.card.pinyinBare = first.pinyin
                .toLowerCase()
                .replace(/[1-5]/g, '')
                .normalize('NFD')
                .replace(/[\\u0300-\\u036f]/g, '')
                .replace(/\\s+/g, '')
                .trim();

            const dn = $('#deckName');
            if (dn) dn.textContent = state.imported.deckName;

            renderFront();
            resetAllBack();

            const choices = $$('[data-choice]', $('#modHanzi'));
            const distractors = ['ÁéØÂ¢É', 'Ê¨¢ÂΩ±', 'Ê¨¢ËøéÂêß', 'ÁºìÂ∫î', 'Ê¨¢È•Æ', 'Êç¢Â∫î'];
            const arr = [state.card.word, ...distractors].slice(0, choices.length);
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor((i * 7 + 3) % (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            choices.forEach((b, i) => b.textContent = arr[i] || state.card.word);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Tabs
            on('#tabFlash', 'click', () => setTab('flash'));
            on('#tabTranslate', 'click', () => setTab('translate'));
            on('#tabSettings', 'click', () => setTab('settings'));

            // Flash controls (Next doubles as Skip)
            on('#btnFabNext', 'click', () => { cycleFront(); resetAllBack(); });

            // Modality binds
            bindModality($('#modPron'));
            bindModality($('#modPinyin'));
            bindModality($('#modHanzi'));
            bindModality($('#modMeaning'));

            // Translation controls
            on('#dirENZH', 'click', () => setTranslationDir('ENZH'));
            on('#dirZHEN', 'click', () => setTranslationDir('ZHEN'));
            on('#btnSubmitTranslation', 'click', () => showTranslateB());
            on('#btnNewSentence', 'click', () => newSentence());
            on('#btnBackToInput', 'click', () => showTranslateA());

            const fb = $('#fbSentence');
            if (fb) {
                fb.addEventListener('click', (e) => {
                    const t = e.target;
                    const btn = (t instanceof HTMLElement) ? t.closest('button.w') : null;
                    if (!btn) return;
                    const idx = Number(btn.dataset.idx);
                    if (Number.isFinite(idx)) setDetail(idx);
                });
            }

            // Settings controls
            on('#apiKey', 'input', renderKeyStatus);
            on('#btnSaveKey', 'click', renderKeyStatus);
            on('#btnClearKey', 'click', () => { const k = $('#apiKey'); if (k) k.value = ''; renderKeyStatus(); });

            on('#btnImport', 'click', () => {
                const text = ($('#wordlistJson')?.value || '');
                const v = validateWordlistJson(text);
                if (!v.ok) return showImportMessage('error', v.msg);
                showImportMessage('ok', `Imported ${v.data.length} word${v.data.length === 1 ? '' : 's'}.`);
                applyImportedDeck(v.data);
            });

            on('#btnClearList', 'click', () => {
                const wl = $('#wordlistJson');
                if (wl) wl.value = '[]';
                const err = $('#importError');
                const ok = $('#importOk');
                if (err) err.style.display = 'none';
                if (ok) ok.style.display = 'none';
            });

            on('#btnReset', 'click', () => {
                setTab('flash');
                state.sessionCount = 12;
                state.card.front = 'hanzi';
                state.card.word = 'Ê¨¢Ëøé';
                state.card.pinyinToned = 'huƒÅny√≠ng';
                state.card.pinyinBare = 'huanying';
                state.card.tones = '12';
                state.card.meaning = 'welcome';
                const dn = $('#deckName');
                if (dn) dn.textContent = 'My Wordlist';
                resetAllBack();
                renderFront();
                setTranslationDir('ENZH');
                const ut = $('#userTranslation');
                if (ut) ut.value = '';
                const err = $('#importError');
                const ok = $('#importOk');
                if (err) err.style.display = 'none';
                if (ok) ok.style.display = 'none';
                const k = $('#apiKey');
                if (k) k.value = '';
                renderKeyStatus();
            });

            // Init
            setTab('flash');
            resetAllBack();
            renderFront();
            setTranslationDir('ENZH');
            renderKeyStatus();
            renderFeedbackTokens();
            runSmokeTests();
        });
    </script>
</body>

</html>